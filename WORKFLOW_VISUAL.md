# 🎨 Визуализация workflow - MONO-REPO

## 🌳 **СТРУКТУРА РЕПОЗИТОРИЯ:**

```
peak-flow-diary/
│
├── 🌐 main branch                    ← ВЫ СЕЙЧАС ЗДЕСЬ
│   │
│   ├── src/                          # Общий код
│   ├── eas.json                      # Конфиг мобильных
│   ├── app.config.js                 # Конфиг всех платформ
│   ├── .cursorules                   # Правила Cursor
│   └── scripts/safe-push.sh          # Защита от случайного деплоя
│   │
│   └── git push → ⚡ АВТОДЕПЛОЙ → 🌐 peakflow.oxia.life
│
├── 📱 mobile/staging branch
│   │
│   └── eas build --profile preview → 🧪 Тестовые билды
│
└── 🚀 mobile/production branch
    │
    └── eas build --profile production → 📦 Релизы
        ├── → 🍎 App Store
        └── → 🤖 Google Play
```

---

## 🔄 **WORKFLOW СЦЕНАРИИ:**

### **1️⃣ ВЕБ-РАЗРАБОТКА (main)**

```
┌─────────────────────────────────────────────────────────────┐
│ Cursor (main branch)                                        │
├─────────────────────────────────────────────────────────────┤
│ 1. Редактируете код в src/                                 │
│ 2. npm run web  → тестируете локально                      │
│ 3. git add . && git commit -m "Web: Fix bug"              │
│ 4. npm run safe-push  → подтверждение                     │
│ 5. git push origin main                                     │
└─────────────────────────────────────────────────────────────┘
                          ↓
                ⚡ АВТОДЕПЛОЙ (2-3 минуты)
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🌐 https://peakflow.oxia.life                              │
│                                                             │
│ ✅ Веб обновлен!                                           │
└─────────────────────────────────────────────────────────────┘

mobile/staging и mobile/production НЕ затронуты ✅
```

---

### **2️⃣ МОБИЛЬНАЯ РАЗРАБОТКА (mobile/staging)**

```
┌─────────────────────────────────────────────────────────────┐
│ Cursor (переключаемся на mobile/staging)                   │
├─────────────────────────────────────────────────────────────┤
│ git checkout mobile/staging                                 │
│ git merge main  → берем последние общие изменения          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Разработка новой мобильной фичи                            │
├─────────────────────────────────────────────────────────────┤
│ 1. Редактируете код в src/                                 │
│ 2. Используете Platform.OS проверки:                        │
│    if (Platform.OS !== 'web') {                            │
│      // Мобильный код                                       │
│    }                                                        │
│ 3. npm start → тестируете на телефоне (Expo Go)           │
│ 4. git commit -m "Mobile: Add feature X"                   │
│ 5. git push origin mobile/staging                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ npm run mobile:preview                                      │
│                                                             │
│ EAS собирает тестовый билд                                 │
│ ⏱️ Ожидание: 15-20 минут                                   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🧪 Тестирование на реальных устройствах                    │
│                                                             │
│ - Скачиваете APK/IPA                                       │
│ - Устанавливаете на телефон                                │
│ - Проверяете функциональность                              │
└─────────────────────────────────────────────────────────────┘

main НЕ затронут, веб продолжает работать ✅
```

---

### **3️⃣ РЕЛИЗ В APP STORE / GOOGLE PLAY (mobile/production)**

```
┌─────────────────────────────────────────────────────────────┐
│ Cursor (переключаемся на mobile/production)                │
├─────────────────────────────────────────────────────────────┤
│ git checkout mobile/production                              │
│ git merge mobile/staging  → берем протестированный код     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Обновление версии в app.config.js                          │
├─────────────────────────────────────────────────────────────┤
│ version: "1.0.0" → "1.1.0"                                 │
│ iOS buildNumber: "1" → "2"                                 │
│ Android versionCode: 1 → 2                                  │
│                                                             │
│ git commit -m "Mobile: Bump version to 1.1.0"              │
│ git push origin mobile/production                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ npm run mobile:build:all                                    │
│                                                             │
│ EAS собирает продакшн билды:                               │
│ ⏱️ iOS: ~30 минут                                          │
│ ⏱️ Android: ~20 минут                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ npm run mobile:submit:all                                   │
│                                                             │
│ EAS загружает в сторы:                                     │
│ 🍎 App Store Connect                                       │
│ 🤖 Google Play Console                                     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🕐 ОЖИДАНИЕ РЕВЬЮ                                          │
│                                                             │
│ 🤖 Google Play: несколько часов - 1 день                   │
│ 🍎 App Store: 1-3 дня                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🎉 ОПУБЛИКОВАНО!                                           │
│                                                             │
│ 🍎 https://apps.apple.com/app/idXXXXXXXXXX                 │
│ 🤖 https://play.google.com/store/apps/details?id=...       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Финализация                                                 │
├─────────────────────────────────────────────────────────────┤
│ git tag -a mobile-v1.1.0 -m "Mobile Release 1.1.0"        │
│ git push origin mobile-v1.1.0                              │
│ git checkout main  → возвращаемся                          │
└─────────────────────────────────────────────────────────────┘

main НЕ затронут, веб продолжает работать ✅
```

---

## 🔒 **ЗАЩИТА ОТ СЛУЧАЙНЫХ ОШИБОК:**

### **1. Скрипт safe-push.sh:**

```bash
npm run safe-push
```

```
🔍 Текущая ветка: main
⚠️  ВНИМАНИЕ! Вы собираетесь пушить в MAIN!
   Это автоматически задеплоит изменения на peakflow.oxia.life

🔍 Проверьте:
   - Это веб-изменения или общие фиксы?
   - Протестировали npm run web?
   - Нет мобильно-специфичного кода?

Продолжить push в main? (yes/no): _
```

**Если "no"** → push отменен ✅
**Если "yes"** → push выполнен

---

### **2. .cursorules (автоматические подсказки):**

Cursor будет напоминать:
- ✅ `main` = только веб
- ✅ Используйте `Platform.OS` проверки
- ✅ Тестируйте `npm run web` перед push в main

---

### **3. .gitignore (защита credentials):**

```
google-play-service-account.json  ← НЕ попадет в Git
*.keystore                         ← НЕ попадет в Git
ios/                               ← НЕ попадет в Git
android/                           ← НЕ попадет в Git
```

---

## 📊 **TIMELINE ЗАПУСКА МОБИЛЬНЫХ ПРИЛОЖЕНИЙ:**

```
День 1-2:   Установка EAS CLI, вход в Expo
            └─ 1-2 часа

День 3:     Регистрация Google Play ($25)
            └─ 30 минут + до 48 часов ожидания подтверждения

День 4:     Настройка App Store Connect
            └─ 30 минут

День 5-6:   Первые тестовые сборки
            ├─ Android preview: 20 минут
            ├─ iOS preview: 30 минут
            └─ Тестирование: 1-2 часа

День 7-8:   Подготовка ассетов
            ├─ Скриншоты: 2 часа
            ├─ Описания: 1 час
            └─ Feature graphic: 30 минут

День 9-10:  Продакшн сборки
            ├─ iOS build: 30 минут
            ├─ Android build: 20 минут
            └─ Загрузка в сторы: 1 час

День 11-12: Заполнение Store Listings
            ├─ Google Play: 1 час
            └─ App Store: 1 час

День 13-15: Ревью в сторах
            ├─ Google Play: несколько часов - 1 день
            └─ App Store: 1-3 дня

День 16:    🎉 ОПУБЛИКОВАНО!
```

**ИТОГО:** ~2 недели (с учетом ожиданий)

---

## 💰 **СТОИМОСТЬ:**

| Компонент | Стоимость | Частота |
|-----------|-----------|---------|
| Apple Developer | $99 | /год (уже есть ✅) |
| Google Play | $25 | один раз |
| Expo (Free tier) | $0 | - |
| EAS Build (Free tier) | $0 | лимит: ~10 билдов/месяц |
| **ИТОГО первый год:** | **$25** | (так как Apple уже есть) |

**Опционально:**
- EAS Build (Paid): $29/месяц (unlimited builds)

---

## 🎯 **ИТОГОВАЯ СТРУКТУРА:**

```
ПЛАТФОРМЫ:
├── 🌐 ВЕБ
│   ├── URL: https://peakflow.oxia.life
│   ├── Деплой: автоматический (main → Vercel)
│   └── Время обновления: 2-3 минуты
│
├── 🍎 iOS
│   ├── Store: App Store
│   ├── Деплой: ручной (EAS → App Store Connect)
│   ├── Время сборки: ~30 минут
│   └── Время ревью: 1-3 дня
│
└── 🤖 ANDROID
    ├── Store: Google Play
    ├── Деплой: ручной (EAS → Google Play Console)
    ├── Время сборки: ~20 минут
    └── Время ревью: несколько часов - 1 день

ВЕТКИ:
├── main                    → веб (защищена)
├── mobile/staging          → мобильная разработка
└── mobile/production       → мобильные релизы

ЗАЩИТА:
├── safe-push.sh            → подтверждение перед push в main
├── .cursorules             → автоматические напоминания
└── .gitignore              → защита credentials
```

---

## 📚 **ДОКУМЕНТАЦИЯ (ГДЕ ЧТО ИСКАТЬ):**

| Файл | Когда использовать |
|------|-------------------|
| **README_MOBILE_SETUP.md** | Первое знакомство, общая картина |
| **QUICK_START_CHECKLIST.md** | Пошаговая инструкция с чекбоксами |
| **SETUP_MOBILE.md** | Детальные технические инструкции |
| **BRANCH_STRATEGY.md** | Подробные сценарии работы с ветками |
| **MOBILE_WORKFLOW.md** | Краткие правила и команды |
| **WORKFLOW_VISUAL.md** | Визуализация процессов (ЭТОТ ФАЙЛ) |
| **.cursorules** | Правила для AI в Cursor |

---

## 🚀 **БЫСТРЫЙ СТАРТ (3 КОМАНДЫ):**

```bash
# 1. Установите EAS
npm install -g eas-cli

# 2. Войдите в Expo
eas login

# 3. Инициализируйте проект
cd /Users/monastyrskaya/Documents/peak-flow-diary
eas build:configure
```

**Дальше:** Следуйте `QUICK_START_CHECKLIST.md` ✅

---

## 🎨 **ВИЗУАЛИЗАЦИЯ MULTI-PLATFORM КОДБЕЙЗА:**

```
src/
├── components/
│   ├── PrimaryButton.tsx       ← Используется везде
│   │   └── if (Platform.OS === 'web') { ... }
│   │
│   ├── ShareButton.tsx         ← Общий интерфейс
│   ├── ShareButton.web.tsx     ← Автовыбор для веба
│   ├── ShareButton.ios.tsx     ← Автовыбор для iOS
│   └── ShareButton.android.tsx ← Автовыбор для Android
│
├── screens/
│   ├── GraphScreen.tsx         ← Используется везде
│   │   └── renderChart() {
│   │         if (Platform.OS === 'web') {
│   │           return <WebOptimizedChart />;
│   │         }
│   │         return <MobileChart />;
│   │       }
│   │
│   └── AddEntryScreen.tsx      ← Используется везде
│       └── DatePicker component автоматически адаптируется
│
└── services/
    ├── SupabaseService.ts      ← Общий для всех платформ
    └── Storage.ts              ← AsyncStorage (везде одинаково)
```

**Принцип:** Один код → три платформы ✅

---

## 🔄 **СИНХРОНИЗАЦИЯ ВЕТОК:**

### **Когда синхронизировать mobile ← main:**

```bash
# Еженедельно или после важных фиксов в main
git checkout mobile/staging
git merge main
git push origin mobile/staging

git checkout mobile/production
git merge main
git push origin mobile/production

git checkout main
```

**Зачем:** Чтобы мобильные ветки получили последние общие изменения из main.

---

### **Когда НЕ синхронизировать main ← mobile:**

**Почти никогда!**

Мобильные изменения остаются в mobile ветках.

**Исключение:** Если добавили общую фичу в mobile, которая нужна и вебу:

```bash
git checkout main
git cherry-pick <commit-hash-from-mobile>
npm run web  # Проверьте!
git push origin main
```

---

## 🎉 **ВЫ ГОТОВЫ!**

Вся инфраструктура настроена:
- ✅ Безопасная структура веток
- ✅ Защита от случайных ошибок
- ✅ Детальная документация
- ✅ Пошаговые инструкции

**Следующий шаг:**
Откройте `QUICK_START_CHECKLIST.md` и начните с Дня 1! 🚀

---

**Удачи с запуском мобильных приложений!** 🎊


